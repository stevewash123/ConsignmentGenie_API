// Add this after line 13 (with other usings):
using Serilog;
using Serilog.Sinks.PostgreSQL;

// Add this after line 15 (before var builder = WebApplication.CreateBuilder(args)):
// Configure Serilog for PostgreSQL logging
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .MinimumLevel.Override("Microsoft", Serilog.Events.LogEventLevel.Warning)
    .MinimumLevel.Override("Microsoft.Hosting.Lifetime", Serilog.Events.LogEventLevel.Information)
    .WriteTo.Console()
    .WriteTo.PostgreSQL(
        connectionString: builder.Configuration.GetConnectionString("DefaultConnection"),
        tableName: "ApplicationLogs",
        needAutoCreateTable: false, // We created it via migration
        columnOptions: new Dictionary<string, ColumnWriterBase>
        {
            {"message", new RenderedMessageColumnWriter()},
            {"level", new LevelColumnWriter()},
            {"timestamp", new TimestampColumnWriter()},
            {"exception", new ExceptionColumnWriter()},
            {"properties", new LogEventSerializedColumnWriter()}
        })
    .CreateLogger();

builder.Host.UseSerilog();

// Add this just before app.Run() at the end:
try
{
    Log.Information("Starting ConsignmentGenie API");
    app.Run();
}
catch (Exception ex)
{
    Log.Fatal(ex, "Application terminated unexpectedly");
}
finally
{
    Log.CloseAndFlush();
}
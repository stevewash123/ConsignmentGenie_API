using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using Moq;
using Xunit;
using ConsignmentGenie.API.Controllers;
using ConsignmentGenie.Application.DTOs.Shopper;
using ConsignmentGenie.Application.Services.Interfaces;

namespace ConsignmentGenie.Tests.Controllers
{
    public class ShopperAuthControllerTests
    {
        private readonly Mock<IShopperAuthService> _mockShopperAuthService;
        private readonly Mock<ISlugService> _mockSlugService;
        private readonly Mock<ILogger<ShopperAuthController>> _mockLogger;
        private readonly ShopperAuthController _controller;

        public ShopperAuthControllerTests()
        {
            _mockShopperAuthService = new Mock<IShopperAuthService>();
            _mockSlugService = new Mock<ISlugService>();
            _mockLogger = new Mock<ILogger<ShopperAuthController>>();

            _controller = new ShopperAuthController(
                _mockShopperAuthService.Object,
                _mockSlugService.Object,
                _mockLogger.Object
            );
        }

        #region Register Tests

        [Fact]
        public async Task Register_ValidRequest_ReturnsOkResult()
        {
            // Arrange
            var storeSlug = "test-store";
            var organizationId = Guid.NewGuid();
            var request = new ShopperRegisterRequest
            {
                FullName = "John Doe",
                Email = "john@example.com",
                Password = "Password123!",
                Phone = "555-123-4567",
                Address = "123 Main St",
                City = "Springfield",
                State = "IL",
                ZipCode = "62701"
            };

            var expectedResponse = new ShopperAuthResponse
            {
                Success = true,
                Token = "jwt-token",
                Shopper = new ShopperDto
                {
                    Id = Guid.NewGuid(),
                    FullName = "John Doe",
                    Email = "john@example.com"
                }
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockShopperAuthService.Setup(s => s.RegisterShopperAsync(organizationId, request))
                .ReturnsAsync(expectedResponse);

            // Act
            var result = await _controller.Register(storeSlug, request);

            // Assert
            var okResult = Assert.IsType<OkObjectResult>(result);
            var response = Assert.IsType<ShopperAuthResponse>(okResult.Value);
            Assert.True(response.Success);
            Assert.Equal("jwt-token", response.Token);
        }

        [Fact]
        public async Task Register_InvalidStoreSlug_ReturnsBadRequest()
        {
            // Arrange
            var storeSlug = "invalid-store";
            var request = new ShopperRegisterRequest
            {
                FullName = "John Doe",
                Email = "john@example.com",
                Password = "Password123!"
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync((Guid?)null);

            // Act
            var result = await _controller.Register(storeSlug, request);

            // Assert
            var badRequestResult = Assert.IsType<BadRequestObjectResult>(result);
            var response = Assert.IsType<ShopperAuthResponse>(badRequestResult.Value);
            Assert.False(response.Success);
            Assert.Equal("Store not found", response.ErrorMessage);
        }

        [Fact]
        public async Task Register_ServiceThrowsException_ReturnsInternalServerError()
        {
            // Arrange
            var storeSlug = "test-store";
            var organizationId = Guid.NewGuid();
            var request = new ShopperRegisterRequest
            {
                FullName = "John Doe",
                Email = "john@example.com",
                Password = "Password123!"
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockShopperAuthService.Setup(s => s.RegisterShopperAsync(organizationId, request))
                .ThrowsAsync(new Exception("Database error"));

            // Act
            var result = await _controller.Register(storeSlug, request);

            // Assert
            var statusCodeResult = Assert.IsType<ObjectResult>(result);
            Assert.Equal(500, statusCodeResult.StatusCode);
            var response = Assert.IsType<ShopperAuthResponse>(statusCodeResult.Value);
            Assert.False(response.Success);
            Assert.Equal("An error occurred during registration", response.ErrorMessage);
        }

        #endregion

        #region Login Tests

        [Fact]
        public async Task Login_ValidCredentials_ReturnsOkResult()
        {
            // Arrange
            var storeSlug = "test-store";
            var organizationId = Guid.NewGuid();
            var request = new ShopperLoginRequest
            {
                Email = "john@example.com",
                Password = "Password123!",
                RememberMe = false
            };

            var expectedResponse = new ShopperAuthResponse
            {
                Success = true,
                Token = "jwt-token",
                Shopper = new ShopperDto
                {
                    Id = Guid.NewGuid(),
                    FullName = "John Doe",
                    Email = "john@example.com"
                }
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockShopperAuthService.Setup(s => s.LoginShopperAsync(organizationId, request))
                .ReturnsAsync(expectedResponse);

            // Act
            var result = await _controller.Login(storeSlug, request);

            // Assert
            var okResult = Assert.IsType<OkObjectResult>(result);
            var response = Assert.IsType<ShopperAuthResponse>(okResult.Value);
            Assert.True(response.Success);
            Assert.Equal("jwt-token", response.Token);
        }

        [Fact]
        public async Task Login_InvalidCredentials_ReturnsUnauthorized()
        {
            // Arrange
            var storeSlug = "test-store";
            var organizationId = Guid.NewGuid();
            var request = new ShopperLoginRequest
            {
                Email = "john@example.com",
                Password = "WrongPassword",
                RememberMe = false
            };

            var expectedResponse = new ShopperAuthResponse
            {
                Success = false,
                ErrorMessage = "Invalid email or password"
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockShopperAuthService.Setup(s => s.LoginShopperAsync(organizationId, request))
                .ReturnsAsync(expectedResponse);

            // Act
            var result = await _controller.Login(storeSlug, request);

            // Assert
            var unauthorizedResult = Assert.IsType<UnauthorizedObjectResult>(result);
            var response = Assert.IsType<ShopperAuthResponse>(unauthorizedResult.Value);
            Assert.False(response.Success);
            Assert.Equal("Invalid email or password", response.ErrorMessage);
        }

        [Fact]
        public async Task Login_InvalidStoreSlug_ReturnsBadRequest()
        {
            // Arrange
            var storeSlug = "invalid-store";
            var request = new ShopperLoginRequest
            {
                Email = "john@example.com",
                Password = "Password123!"
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync((Guid?)null);

            // Act
            var result = await _controller.Login(storeSlug, request);

            // Assert
            var badRequestResult = Assert.IsType<BadRequestObjectResult>(result);
            var response = Assert.IsType<ShopperAuthResponse>(badRequestResult.Value);
            Assert.False(response.Success);
            Assert.Equal("Store not found", response.ErrorMessage);
        }

        #endregion

        #region Guest Session Tests

        [Fact]
        public async Task CreateGuestSession_ValidRequest_ReturnsOkResult()
        {
            // Arrange
            var storeSlug = "test-store";
            var organizationId = Guid.NewGuid();
            var request = new GuestSessionRequest
            {
                Email = "guest@example.com",
                FullName = "Guest User"
            };

            var expectedResponse = new GuestSessionResponse
            {
                Success = true,
                Token = "guest-jwt-token",
                SessionId = "session-123"
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockShopperAuthService.Setup(s => s.CreateGuestSessionAsync(organizationId, request))
                .ReturnsAsync(expectedResponse);

            // Act
            var result = await _controller.CreateGuestSession(storeSlug, request);

            // Assert
            var okResult = Assert.IsType<OkObjectResult>(result);
            var response = Assert.IsType<GuestSessionResponse>(okResult.Value);
            Assert.True(response.Success);
            Assert.Equal("guest-jwt-token", response.Token);
            Assert.Equal("session-123", response.SessionId);
        }

        [Fact]
        public async Task CreateGuestSession_InvalidStoreSlug_ReturnsBadRequest()
        {
            // Arrange
            var storeSlug = "invalid-store";
            var request = new GuestSessionRequest
            {
                Email = "guest@example.com",
                FullName = "Guest User"
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync((Guid?)null);

            // Act
            var result = await _controller.CreateGuestSession(storeSlug, request);

            // Assert
            var badRequestResult = Assert.IsType<BadRequestObjectResult>(result);
            var response = Assert.IsType<GuestSessionResponse>(badRequestResult.Value);
            Assert.False(response.Success);
            Assert.Equal("Store not found", response.ErrorMessage);
        }

        #endregion

        #region Forgot Password Tests

        [Fact]
        public async Task ForgotPassword_ValidEmail_ReturnsOkResult()
        {
            // Arrange
            var storeSlug = "test-store";
            var organizationId = Guid.NewGuid();
            var request = new ForgotPasswordRequest
            {
                Email = "john@example.com"
            };

            var expectedResponse = new BaseResponse
            {
                Success = true,
                Message = "If an account exists with this email, you will receive password reset instructions"
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockShopperAuthService.Setup(s => s.ForgotPasswordAsync(organizationId, request.Email))
                .ReturnsAsync(expectedResponse);

            // Act
            var result = await _controller.ForgotPassword(storeSlug, request);

            // Assert
            var okResult = Assert.IsType<OkObjectResult>(result);
            var response = Assert.IsType<BaseResponse>(okResult.Value);
            Assert.True(response.Success);
        }

        #endregion

        #region Reset Password Tests

        [Fact]
        public async Task ResetPassword_ValidToken_ReturnsOkResult()
        {
            // Arrange
            var storeSlug = "test-store";
            var organizationId = Guid.NewGuid();
            var request = new ResetPasswordRequest
            {
                Token = "reset-token",
                NewPassword = "NewPassword123!"
            };

            var expectedResponse = new BaseResponse
            {
                Success = true,
                Message = "Password reset successfully"
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockShopperAuthService.Setup(s => s.ResetPasswordAsync(organizationId, request))
                .ReturnsAsync(expectedResponse);

            // Act
            var result = await _controller.ResetPassword(storeSlug, request);

            // Assert
            var okResult = Assert.IsType<OkObjectResult>(result);
            var response = Assert.IsType<BaseResponse>(okResult.Value);
            Assert.True(response.Success);
        }

        [Fact]
        public async Task ResetPassword_InvalidToken_ReturnsBadRequest()
        {
            // Arrange
            var storeSlug = "test-store";
            var organizationId = Guid.NewGuid();
            var request = new ResetPasswordRequest
            {
                Token = "invalid-token",
                NewPassword = "NewPassword123!"
            };

            var expectedResponse = new BaseResponse
            {
                Success = false,
                Message = "Invalid or expired reset token"
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockShopperAuthService.Setup(s => s.ResetPasswordAsync(organizationId, request))
                .ReturnsAsync(expectedResponse);

            // Act
            var result = await _controller.ResetPassword(storeSlug, request);

            // Assert
            var badRequestResult = Assert.IsType<BadRequestObjectResult>(result);
            var response = Assert.IsType<BaseResponse>(badRequestResult.Value);
            Assert.False(response.Success);
        }

        #endregion

        #region Helper Method Tests

        [Theory]
        [InlineData("")]
        [InlineData(null)]
        [InlineData("   ")]
        public async Task Register_EmptyStoreSlug_ReturnsBadRequest(string storeSlug)
        {
            // Arrange
            var request = new ShopperRegisterRequest
            {
                FullName = "John Doe",
                Email = "john@example.com",
                Password = "Password123!"
            };

            // Act
            var result = await _controller.Register(storeSlug, request);

            // Assert
            var badRequestResult = Assert.IsType<BadRequestObjectResult>(result);
            var response = Assert.IsType<ShopperAuthResponse>(badRequestResult.Value);
            Assert.False(response.Success);
            Assert.Equal("Store not found", response.ErrorMessage);
        }

        [Fact]
        public async Task Login_NullRequest_ThrowsArgumentNullException()
        {
            // Arrange
            var storeSlug = "test-store";

            // Act & Assert
            await Assert.ThrowsAsync<ArgumentNullException>(
                () => _controller.Login(storeSlug, null));
        }

        [Fact]
        public async Task Register_NullRequest_ThrowsArgumentNullException()
        {
            // Arrange
            var storeSlug = "test-store";

            // Act & Assert
            await Assert.ThrowsAsync<ArgumentNullException>(
                () => _controller.Register(storeSlug, null));
        }

        #endregion
    }
}
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using Moq;
using Xunit;
using ConsignmentGenie.API.Controllers;
using ConsignmentGenie.Application.DTOs.Shopper;
using ConsignmentGenie.Application.Services.Interfaces;

namespace ConsignmentGenie.Tests.Controllers
{
    public class ShopPublicControllerTests
    {
        private readonly Mock<ISlugService> _mockSlugService;
        private readonly Mock<ILogger<ShopPublicController>> _mockLogger;
        private readonly ShopPublicController _controller;

        public ShopPublicControllerTests()
        {
            _mockSlugService = new Mock<ISlugService>();
            _mockLogger = new Mock<ILogger<ShopPublicController>>();

            _controller = new ShopPublicController(
                _mockSlugService.Object,
                _mockLogger.Object
            );
        }

        #region GetStoreInfo Tests

        [Fact]
        public async Task GetStoreInfo_ValidStoreSlug_ReturnsOkResult()
        {
            // Arrange
            var storeSlug = "test-store";
            var organizationId = Guid.NewGuid();
            var expectedStoreInfo = new StoreInfoDto
            {
                Id = organizationId,
                Name = "Test Store",
                Slug = storeSlug,
                Description = "A test store for consignment items",
                Address = "123 Main St",
                City = "Springfield",
                State = "IL",
                ZipCode = "62701",
                Phone = "555-123-4567",
                Email = "info@teststore.com",
                LogoUrl = "https://example.com/logo.jpg",
                BannerUrl = "https://example.com/banner.jpg",
                IsActive = true,
                BusinessHours = "Mon-Fri 9AM-6PM",
                Website = "https://teststore.com",
                FacebookUrl = "https://facebook.com/teststore",
                InstagramUrl = "https://instagram.com/teststore"
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockSlugService.Setup(s => s.GetStoreInfoAsync(organizationId))
                .ReturnsAsync(expectedStoreInfo);

            // Act
            var result = await _controller.GetStoreInfo(storeSlug);

            // Assert
            var okResult = Assert.IsType<OkObjectResult>(result);
            var storeInfo = Assert.IsType<StoreInfoDto>(okResult.Value);
            Assert.Equal("Test Store", storeInfo.Name);
            Assert.Equal(storeSlug, storeInfo.Slug);
            Assert.Equal("A test store for consignment items", storeInfo.Description);
            Assert.True(storeInfo.IsActive);
        }

        [Fact]
        public async Task GetStoreInfo_InvalidStoreSlug_ReturnsNotFound()
        {
            // Arrange
            var storeSlug = "invalid-store";

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync((Guid?)null);

            // Act
            var result = await _controller.GetStoreInfo(storeSlug);

            // Assert
            var notFoundResult = Assert.IsType<NotFoundObjectResult>(result);
            var errorMessage = Assert.IsType<string>(notFoundResult.Value);
            Assert.Equal("Store not found", errorMessage);
        }

        [Fact]
        public async Task GetStoreInfo_StoreExistsButInfoNotFound_ReturnsNotFound()
        {
            // Arrange
            var storeSlug = "test-store";
            var organizationId = Guid.NewGuid();

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockSlugService.Setup(s => s.GetStoreInfoAsync(organizationId))
                .ReturnsAsync((StoreInfoDto)null);

            // Act
            var result = await _controller.GetStoreInfo(storeSlug);

            // Assert
            var notFoundResult = Assert.IsType<NotFoundObjectResult>(result);
            var errorMessage = Assert.IsType<string>(notFoundResult.Value);
            Assert.Equal("Store not found", errorMessage);
        }

        [Fact]
        public async Task GetStoreInfo_InactiveStore_ReturnsNotFound()
        {
            // Arrange
            var storeSlug = "inactive-store";
            var organizationId = Guid.NewGuid();
            var inactiveStoreInfo = new StoreInfoDto
            {
                Id = organizationId,
                Name = "Inactive Store",
                Slug = storeSlug,
                IsActive = false
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockSlugService.Setup(s => s.GetStoreInfoAsync(organizationId))
                .ReturnsAsync(inactiveStoreInfo);

            // Act
            var result = await _controller.GetStoreInfo(storeSlug);

            // Assert
            var notFoundResult = Assert.IsType<NotFoundObjectResult>(result);
            var errorMessage = Assert.IsType<string>(notFoundResult.Value);
            Assert.Equal("Store is not available", errorMessage);
        }

        [Fact]
        public async Task GetStoreInfo_ServiceThrowsException_ReturnsInternalServerError()
        {
            // Arrange
            var storeSlug = "test-store";
            var organizationId = Guid.NewGuid();

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockSlugService.Setup(s => s.GetStoreInfoAsync(organizationId))
                .ThrowsAsync(new Exception("Database connection failed"));

            // Act
            var result = await _controller.GetStoreInfo(storeSlug);

            // Assert
            var statusCodeResult = Assert.IsType<ObjectResult>(result);
            Assert.Equal(500, statusCodeResult.StatusCode);
            var errorMessage = Assert.IsType<string>(statusCodeResult.Value);
            Assert.Equal("An error occurred while retrieving store information", errorMessage);
        }

        #endregion

        #region Validation Tests

        [Theory]
        [InlineData("")]
        [InlineData(null)]
        [InlineData("   ")]
        public async Task GetStoreInfo_EmptyOrNullStoreSlug_ReturnsNotFound(string storeSlug)
        {
            // Act
            var result = await _controller.GetStoreInfo(storeSlug);

            // Assert
            var notFoundResult = Assert.IsType<NotFoundObjectResult>(result);
            var errorMessage = Assert.IsType<string>(notFoundResult.Value);
            Assert.Equal("Store not found", errorMessage);
        }

        [Theory]
        [InlineData("valid-store-slug")]
        [InlineData("store123")]
        [InlineData("my-awesome-store")]
        [InlineData("store-with-numbers-123")]
        public async Task GetStoreInfo_ValidSlugFormats_CallsService(string storeSlug)
        {
            // Arrange
            var organizationId = Guid.NewGuid();

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockSlugService.Setup(s => s.GetStoreInfoAsync(organizationId))
                .ReturnsAsync((StoreInfoDto)null);

            // Act
            var result = await _controller.GetStoreInfo(storeSlug);

            // Assert
            _mockSlugService.Verify(s => s.GetOrganizationBySlugAsync(storeSlug), Times.Once);
            _mockSlugService.Verify(s => s.GetStoreInfoAsync(organizationId), Times.Once);
        }

        #endregion

        #region Store Information Completeness Tests

        [Fact]
        public async Task GetStoreInfo_StoreWithMinimalInfo_ReturnsBasicData()
        {
            // Arrange
            var storeSlug = "minimal-store";
            var organizationId = Guid.NewGuid();
            var minimalStoreInfo = new StoreInfoDto
            {
                Id = organizationId,
                Name = "Minimal Store",
                Slug = storeSlug,
                IsActive = true
                // All other fields are null/empty
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockSlugService.Setup(s => s.GetStoreInfoAsync(organizationId))
                .ReturnsAsync(minimalStoreInfo);

            // Act
            var result = await _controller.GetStoreInfo(storeSlug);

            // Assert
            var okResult = Assert.IsType<OkObjectResult>(result);
            var storeInfo = Assert.IsType<StoreInfoDto>(okResult.Value);
            Assert.Equal("Minimal Store", storeInfo.Name);
            Assert.Equal(storeSlug, storeInfo.Slug);
            Assert.True(storeInfo.IsActive);
            Assert.Null(storeInfo.Description);
            Assert.Null(storeInfo.LogoUrl);
        }

        [Fact]
        public async Task GetStoreInfo_StoreWithCompleteInfo_ReturnsAllData()
        {
            // Arrange
            var storeSlug = "complete-store";
            var organizationId = Guid.NewGuid();
            var completeStoreInfo = new StoreInfoDto
            {
                Id = organizationId,
                Name = "Complete Store",
                Slug = storeSlug,
                Description = "A store with complete information",
                Address = "123 Complete St",
                City = "Complete City",
                State = "CC",
                ZipCode = "12345",
                Phone = "555-123-4567",
                Email = "info@completestore.com",
                LogoUrl = "https://example.com/logo.jpg",
                BannerUrl = "https://example.com/banner.jpg",
                IsActive = true,
                BusinessHours = "24/7",
                Website = "https://completestore.com",
                FacebookUrl = "https://facebook.com/completestore",
                InstagramUrl = "https://instagram.com/completestore"
            };

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockSlugService.Setup(s => s.GetStoreInfoAsync(organizationId))
                .ReturnsAsync(completeStoreInfo);

            // Act
            var result = await _controller.GetStoreInfo(storeSlug);

            // Assert
            var okResult = Assert.IsType<OkObjectResult>(result);
            var storeInfo = Assert.IsType<StoreInfoDto>(okResult.Value);

            Assert.Equal("Complete Store", storeInfo.Name);
            Assert.Equal("A store with complete information", storeInfo.Description);
            Assert.Equal("123 Complete St", storeInfo.Address);
            Assert.Equal("Complete City", storeInfo.City);
            Assert.Equal("CC", storeInfo.State);
            Assert.Equal("12345", storeInfo.ZipCode);
            Assert.Equal("555-123-4567", storeInfo.Phone);
            Assert.Equal("info@completestore.com", storeInfo.Email);
            Assert.Equal("https://example.com/logo.jpg", storeInfo.LogoUrl);
            Assert.Equal("https://example.com/banner.jpg", storeInfo.BannerUrl);
            Assert.Equal("24/7", storeInfo.BusinessHours);
            Assert.Equal("https://completestore.com", storeInfo.Website);
            Assert.Equal("https://facebook.com/completestore", storeInfo.FacebookUrl);
            Assert.Equal("https://instagram.com/completestore", storeInfo.InstagramUrl);
        }

        #endregion

        #region Service Call Verification Tests

        [Fact]
        public async Task GetStoreInfo_ValidRequest_CallsServicesInCorrectOrder()
        {
            // Arrange
            var storeSlug = "test-store";
            var organizationId = Guid.NewGuid();
            var sequence = new MockSequence();

            _mockSlugService.InSequence(sequence)
                .Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync(organizationId);

            _mockSlugService.InSequence(sequence)
                .Setup(s => s.GetStoreInfoAsync(organizationId))
                .ReturnsAsync(new StoreInfoDto
                {
                    Id = organizationId,
                    Name = "Test Store",
                    Slug = storeSlug,
                    IsActive = true
                });

            // Act
            var result = await _controller.GetStoreInfo(storeSlug);

            // Assert
            _mockSlugService.Verify(s => s.GetOrganizationBySlugAsync(storeSlug), Times.Once);
            _mockSlugService.Verify(s => s.GetStoreInfoAsync(organizationId), Times.Once);
        }

        [Fact]
        public async Task GetStoreInfo_OrganizationNotFound_DoesNotCallGetStoreInfo()
        {
            // Arrange
            var storeSlug = "nonexistent-store";

            _mockSlugService.Setup(s => s.GetOrganizationBySlugAsync(storeSlug))
                .ReturnsAsync((Guid?)null);

            // Act
            var result = await _controller.GetStoreInfo(storeSlug);

            // Assert
            _mockSlugService.Verify(s => s.GetOrganizationBySlugAsync(storeSlug), Times.Once);
            _mockSlugService.Verify(s => s.GetStoreInfoAsync(It.IsAny<Guid>()), Times.Never);
        }

        #endregion
    }
}